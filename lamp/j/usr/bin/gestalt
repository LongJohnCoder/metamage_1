#!/usr/bin/perl -w

my $device = '/sys/mac/gestalt';

my $default_display = 'x';

my %formats =
(
	b => '.32b',
	x => '.8x',
	d => 'd',
	k => sub
	{
		my @x = qw( K M G );
		my $x = '';
		$_ /= 1000, $x = shift @x while $_ >= 1000;
		".1f ${x}Hz";
	},
	t => sub { $_ = pack "L", $_; "s" },
);

my $display = $default_display;

my $arg = shift;

if ( $arg =~ m/^ - ([bdxkt]) /x )
{
	$display = $1;
	
	$arg = shift;
}

my $selector = $arg;

length $selector == 4 or die "Selector must be length 4";

my $request = unpack "L", $selector;

open my $gestalt, '<', $device or die "Can't open $device ($!)";

my $result = '0000';

if ( not ioctl( $gestalt, $request, $result ) )
{
	exit 1 if $! == 22;  # EINVAL, no such Gestalt selector
	
	die "Can't ioctl ($!)";
}

my $output = unpack "L", $result;

my $format = $formats{ $display };

ref $format and $format = $format->() for $output;

printf "\%$format\n", $output;

